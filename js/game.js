(function(t,e){"use strict";var i="AxmTYklsjo190QW",s="sans-serif",a="serif",n={tolerance:2,delay:100,glyphs:"",success:function(){},error:function(){},timeout:5e3,weight:"400",style:"normal"},r=["display:block","position:absolute","top:-999px","left:-999px","font-size:48px","width:auto","height:auto","line-height:normal","margin:0","padding:0","font-variant:normal","white-space:nowrap"],o='<div style="%s">'+i+"</div>";var h=function(){this.fontFamily="";this.appended=false;this.serif=undefined;this.sansSerif=undefined;this.parent=undefined;this.options={}};h.prototype.getMeasurements=function(){return{sansSerif:{width:this.sansSerif.offsetWidth,height:this.sansSerif.offsetHeight},serif:{width:this.serif.offsetWidth,height:this.serif.offsetHeight}}};h.prototype.load=function(){var i=new Date,n=this,h=n.serif,d=n.sansSerif,l=n.parent,p=n.appended,f,u=n.options,g=u.reference;function c(t){return r.concat(["font-weight:"+u.weight,"font-style:"+u.style]).concat("font-family:"+t).join(";")}var m=o.replace(/\%s/,c(s)),y=o.replace(/\%s/,c(a));if(!l){l=n.parent=e.createElement("div")}l.innerHTML=m+y;d=n.sansSerif=l.firstChild;h=n.serif=d.nextSibling;if(u.glyphs){d.innerHTML+=u.glyphs;h.innerHTML+=u.glyphs}function b(t,e,i){return Math.abs(t.width-e.offsetWidth)>i||Math.abs(t.height-e.offsetHeight)>i}function v(){return(new Date).getTime()-i.getTime()>u.timeout}(function i(){if(!g){g=e.body}if(!p&&g){g.appendChild(l);p=n.appended=true;f=n.getMeasurements();d.style.fontFamily=n.fontFamily+", "+s;h.style.fontFamily=n.fontFamily+", "+a}if(p&&f&&(b(f.sansSerif,d,u.tolerance)||b(f.serif,h,u.tolerance))){u.success()}else if(v()){u.error()}else{if(!p&&"requestAnimationFrame"in window){t.requestAnimationFrame(i)}else{t.setTimeout(i,u.delay)}}})()};h.prototype.cleanFamilyName=function(t){return t.replace(/[\'\"]/g,"").toLowerCase()};h.prototype.cleanWeight=function(t){var e={normal:"400",bold:"700"};return""+(e[t]||t)};h.prototype.checkFontFaces=function(i){var s=this;e.fonts.forEach(function(e){if(s.cleanFamilyName(e.family)===s.cleanFamilyName(s.fontFamily)&&s.cleanWeight(e.weight)===s.cleanWeight(s.options.weight)&&e.style===s.options.style){e.load().then(function(){s.options.success();t.clearTimeout(i)})}})};h.prototype.init=function(i,s){var a;for(var r in n){if(!s.hasOwnProperty(r)){s[r]=n[r]}}this.options=s;this.fontFamily=i;if(!s.glyphs&&"fonts"in e){if(s.timeout){a=t.setTimeout(function(){s.error()},s.timeout)}this.checkFontFaces(a)}else{this.load()}};var d=function(t,e){var i=new h;i.init(t,e);return i};t.FontFaceOnload=d})(this,this.document);function intersectsRects(t,e,i,s,a,n,r,o,h,d){n-=t;r-=e;var l=Math.sin(-a);var p=Math.cos(-a);var f=n*p-r*l;var u=n*l+r*p;d-=a;n=t+f;r=e+u;l=Math.sin(d);cs=Math.cos(d);var g=o/2;var c=h/2;var m=rotatePoint(l,cs,-g,-c);m.x+=n;m.y+=r;var y=rotatePoint(l,cs,g,-c);y.x+=n;y.y+=r;var b=rotatePoint(l,cs,-g,c);b.x+=n;b.y+=r;var v=rotatePoint(l,cs,g,c);v.x+=n;v.y+=r;var T=false;T=T||intersectsRectLine(t,e,i,s,m.x,m.y,y.x,y.y);T=T||intersectsRectLine(t,e,i,s,b.x,b.y,v.x,v.y);T=T||intersectsRectLine(t,e,i,s,m.x,m.y,b.x,b.y);T=T||intersectsRectLine(t,e,i,s,y.x,y.y,v.x,v.y);return T}function rotatePointX(t,e,i,s){return i*e-s*t}function rotatePointY(t,e,i,s){return i*t+s*e}function rotatePoint(t,e,i,s){return{x:rotatePointX(t,e,i,s),y:rotatePointY(t,e,i,s)}}function intersectsRectLine(t,e,i,s,a,n,r,o){t-=i/2;e-=s/2;var h=a;var d=r;if(a>r){h=r;d=a}if(d>t+i)d=t+i;if(h<t)h=t;if(h>d)return false;var l=n;var p=o;var f=r-a;if(Math.abs(f)>1e-7){var u=(o-n)/f;var g=n-u*a;l=u*h+g;p=u*d+g}if(l>p){var c=p;p=l;l=c}if(p>e+s)p=e+s;if(l<e)l=e;if(l>p)return false;return true}function setCookie(t,e,i){var s=new Date;s.setTime(s.getTime()+i*24*60*60*1e3);var a="expires="+s.toUTCString();document.cookie=t+"="+e+";"+a+";path=/"}function getCookie(t){var e=t+"=";var i=document.cookie.split(";");for(var s=0;s<i.length;s++){var a=i[s];while(a.charAt(0)==" "){a=a.substring(1)}if(a.indexOf(e)==0){return a.substring(e.length,a.length)}}return""}const BEST_SCORE_COOKIE_NAME="BEST_SCORE";const LEADERBOARD_API_PATH="api/leaderboard.php";const LEADERBOARD_URL=LEADERBOARD_API_PATH;const LEGAL_SYMBOLS="-_";const MAX_NAME_LENGTH=16;const NUM_LEADERBOARD_ENTRIES=10;function setBestScore(t){setCookie(BEST_SCORE_COOKIE_NAME,t,365);console.log("Best score set: "+t)}function getBestScore(){var t=parseInt(getCookie(BEST_SCORE_COOKIE_NAME));if(isNaN(t)){t=0;setBestScore(0)}return t}function isLegalName(t){if(typeof t!=="string"){return false}else if(t===""){return false}else if(t.length>MAX_NAME_LENGTH){return false}else{for(var e=0;e<t.length;e++)if(!isLegalNameChar(t[e]))return false}return true}function isLegalNameChar(t){var e=function(t){return t.charCodeAt(0)};var i=t.charCodeAt(0);if(i>=e("a")&&i<=e("z")){return true}else if(i>=e("A")&&i<=e("Z")){return true}else if(i>=e("1")&&i<=e("9")){return true}else if(LEGAL_SYMBOLS.indexOf(t)!==-1){return true}return false}function getLeaderboard(t,e){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(this.readyState==4){if(this.status===200){var i=this.responseText;var s=null;try{s=JSON.parse(i)}catch(t){e("Invalid JSON response: "+i)}t(s)}else{e(this.statusText+": "+this.responseText)}}};i.open("GET",LEADERBOARD_URL,true);i.send()}function submitBestScore(t,e,i,s){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(this.readyState==4){if(this.status===200){i()}else{var t=""+this.status;if(this.statusText)t+=" "+this.statusText;t+=": ";s(t+this.responseText)}}};var n="name="+encodeURIComponent(t)+"&score="+encodeURIComponent(e);a.open("POST",LEADERBOARD_URL,true);a.setRequestHeader("Content-Type","application/x-www-form-urlencoded");a.send(n)}function Button(t,e,i,s){this.x=t;this.y=e;this.img=i;this.f=s}Object.defineProperty(Button.prototype,"x",{get:function(){if(typeof this._x==="function")return this._x();else return this._x},set:function(t){this._x=t}});Object.defineProperty(Button.prototype,"y",{get:function(){if(typeof this._y==="function")return this._y();else return this._y},set:function(t){this._y=t}});Button.prototype.draw=function(t){drawImage(t,this.img,this.x,this.y)};Button.prototype.handleClick=function(t,e){if(t>=this.x&&t<this.x+this.img.width&&e>=this.y&&e<this.y+this.img.height){this.f();return true}return false};function DisableButton(t,e,i,s,a,n){this._x=t;this._y=e;this.img=i;this.imgDisabled=s;this.f=a;this.isDisabled=n}Object.defineProperty(DisableButton.prototype,"x",{get:function(){if(typeof this._x==="function")return this._x();else return this._x},set:function(t){this._x=t}});Object.defineProperty(DisableButton.prototype,"y",{get:function(){if(typeof this._y==="function")return this._y();else return this._y},set:function(t){this._y=t}});DisableButton.prototype.draw=function(t){if(this.isDisabled())drawImage(t,this.imgDisabled,this.x,this.y);else drawImage(t,this.img,this.x,this.y)};DisableButton.prototype.handleClick=function(t,e){if(this.isDisabled()){return false}if(t>=this.x&&t<this.x+this.img.width&&e>=this.y&&e<this.y+this.img.height){this.f();return true}return false};function Rect(t,e,i,s,a){this.reuse(t,e,i,s,a)}Rect.prototype.reuse=function(t,e,i,s,a){this.x=t;this.y=e;this.w=i;this.h=s;this.rot=a};Rect.prototype.draw=function(t){var e=-this.w/2;var i=-this.h/2;var s=t.canvas.height-this.y;t.translate(this.x,s);t.rotate(this.rot);t.translate(e,i);t.strokeRect(0,0,this.w,this.h);t.translate(-e,-i);t.rotate(-this.rot);t.translate(-this.x,-s)};Rect.prototype.intersects=function(t){return intersectsRects(this.x,this.y,this.w,this.h,this.rot,t.x,t.y,t.w,t.h,t.rot)};function drawImage(t,e,i,s){var a=e.width,n=e.height;t.drawImage(e,0,0,a,n,Math.round(i),Math.round(s),a,n)}function drawImageTiled(t,e,i,s,a,n){if(typeof i==="undefined")i=0;if(typeof s==="undefined")s=0;if(typeof a==="undefined")a=Infinity;if(typeof n==="undefined")n=Infinity;var r=t.canvas.width,o=t.canvas.height,h=e.width,d=e.height;if(h==0||d==0)return;var l=0;for(var p=s;p<o&&l<n;p+=d){var f=0;for(var u=i;u<r&&f<a;u+=h){drawImage(t,e,u,p,h,d);f+=1}l+=1}}function drawFlappyText(t,e,i,s,a,n,r,o){function h(t,e,i,s,a,n,r){if(typeof n==="undefined")n=0;if(typeof r==="undefined")r=0;n*=a;r*=a;t.fillText(e,i+n,s+r)}if(typeof a==="undefined")a="white";if(typeof n==="undefined")n=5;if(typeof r!=="undefined"){if(r<=0){return}var d=t.measureText("...").width;var l=function(e){return t.measureText(e).width+2*n};var p=function(t){return l(t)+d};var f=l(e);var u=false;while(f>r&&e.length!==0){if(o)e=e.substring(1,e.length);else e=e.substring(0,e.length-1);u=true;f=p(e)}if(u){if(o)e="..."+e;else e=e+"..."}}t.fillStyle="black";h(t,e,i,s,n,1,1);h(t,e,i,s,n,1,-1);h(t,e,i,s,n,-1,1);h(t,e,i,s,n,-1,-1);t.fillStyle=a;h(t,e,i,s,n)}function Pipe(t,e,i){this.reuse(t,e,i)}Pipe.prototype.reuse=function(t,e,i){if(typeof e==="undefined")e=Math.random()*300+200;if(typeof i==="undefined")i=150;this.x=t;this.y=e;this.spacing=i;this.passed=false;if(typeof this.upperCache==="undefined")this.upperCache=new Rect;if(typeof this.lowerCache==="undefined")this.lowerCache=new Rect};const PIPE_H=2e3;Pipe.prototype.bbUpper=function(t){this.upperCache.reuse(this.x+t/2,this.y+this.spacing+PIPE_H/2,t,PIPE_H,0);return this.upperCache};Pipe.prototype.bbLower=function(t){this.lowerCache.reuse(this.x+t/2,this.y/2,t,this.y,0);return this.lowerCache};const BIRD_START_Y=350;function calculateAngle(t,e){return Math.atan(-e/t)}function Bird(){this.posX=0;this.posY=BIRD_START_Y;this.velX=150;this.velY=20;this.ang=calculateAngle(this.velX,this.velY);this.prevAng=this.ang;this.flapButtonDownPrev=false;this.t=0;this.dead=false}Bird.prototype.getBB=function(t,e){return new Rect(this.posX,this.posY,t,e,this.ang)};"use strict";const MIN_CANVAS_WIDTH=400;const MAX_CANVAS_WIDTH=1440;const MIN_CANVAS_HEIGHT=750;const MAX_CANVAS_HEIGHT=850;const BIRD_OFFSET_Y=100;const PIPE_SPACING_X=250;const MAX_VEL_Y=400;const STATE_LOADING=0;const STATE_START=1;const STATE_PLAYING=2;const STATE_PAUSED=3;const STATE_DEATH=4;const STATE_LEADERBOARD=5;const STATE_LEADERBOARD_ERROR=6;const WHICH_CODE_SPACE=32;window.onload=function(){var t=new Game;window.requestAnimationFrame(t.mainLoop.bind(t))};function stateToString(t){if(t===STATE_LOADING)return"STATE_LOADING";else if(t===STATE_START)return"STATE_START";else if(t===STATE_PLAYING)return"STATE_PLAYING";else if(t===STATE_PAUSED)return"STATE_PAUSED";else if(t===STATE_DEATH)return"STATE_DEATH";else if(t===STATE_LEADERBOARD)return"STATE_LEADERBOARD";else if(t===STATE_LEADERBOARD_ERROR)return"STATE_LEADERBOARD_ERROR";else return"Invalid state: "+t}function Game(){this.canvas=document.getElementById("canvas");var t=this;this.canvas.onmousedown=function(e){if(e.button===0){t.lmbDown=true;t.mouseX=e.offsetX;t.mouseY=e.offsetY;console.log("lmb pressed ("+t.mouseX+", "+t.mouseY+")")}};this.canvas.onmouseup=function(e){if(e.button===0){t.lmbDown=false;console.log("lmb released")}};this.lmbDown=false;this.lmbDownPrev=false;this.mouseX=0;this.mouseY=0;this.keyCodes=[];this.keyWhichs=[];this.keyUps=[];this.keyDowns=[];window.onkeyup=function(e){t.keyCodes[e.code]=false;t.keyWhichs[e.which]=false;t.keyUps[t.keyUps.length]=e};window.onkeydown=function(e){t.keyCodes[e.code]=true;t.keyWhichs[e.which]=true;t.keyDowns[t.keyDowns.length]=e};this.flappyFontLoaded=false;FontFaceOnload("FlappyFont",{success:function(){console.log("FlappyFont loaded.");this.flappyFontLoaded=true;this.notifyLoadedFont()}.bind(this),error:function(){console.log("FlappyFont could not be downloaded.");this.flappyFontLoaded=true;this.notifyLoadedFont()}.bind(this)});this.imgs={};this.imgs.flappy=[];this.imgs.deadFlappy=[];this.flappysLoaded=false;var e=function(){if(typeof this.flappysLoadedNum==="undefined")this.flappysLoadedNum=0;this.flappysLoadedNum+=1;if(this.flappysLoadedNum===4)this.flappysLoaded=true}.bind(this);for(var i=0;i<4;i++){this.imgs.flappy[i]=this.loadImage("img/flappy"+i+".png",e)}for(var i=0;i<4;i++){this.imgs.deadFlappy[i]=this.loadImage("img/deadFlappy"+i+".png")}this.imgs.bg=this.loadImage("img/background.png");this.imgs.bgBlank=this.loadImage("img/backgroundBlank.png");this.imgs.pipe=this.loadImage("img/pipe.png");this.imgs.pipeHead=this.loadImage("img/pipeHead.png");this.imgs.ground=this.loadImage("img/ground.png");this.imgs.tapInfo=this.loadImage("img/tapInfo.png");this.imgs.new=this.loadImage("img/new.png");this.imgs.buttonPlay=this.loadImage("img/buttonPlay.png");this.imgs.buttonPause=this.loadImage("img/buttonPause.png");this.imgs.buttonRestart=this.loadImage("img/buttonRestart.png");this.imgs.buttonLeaderboard=this.loadImage("img/buttonLeaderboard.png");this.imgs.buttonSubmit=this.loadImage("img/buttonSubmit.png");this.imgs.buttonSubmitDisabled=this.loadImage("img/buttonSubmitDisabled.png");this.imgs.buttonRetry=this.loadImage("img/buttonRetry.png");var s=Object.getOwnPropertyDescriptor(Game.prototype,"state").set;var a=20;var n=50,r=50;this.buttonPlay=new Button(n,r,this.imgs.buttonPlay,s.bind(this,STATE_PLAYING));this.buttonPause=new Button(n,r,this.imgs.buttonPause,s.bind(this,STATE_PAUSED));var o=400;var h=function(){var t=a+this.imgs.buttonRestart.width+this.imgs.buttonLeaderboard.width;var e=this.canvas.width/2-t/2;return e}.bind(this);this.buttonRestartDeath=new Button(h,o,this.imgs.buttonRestart,s.bind(this,STATE_START));this.buttonLeaderboard=new Button(function(){return h()+a+this.imgs.buttonRestart.width}.bind(this),o,this.imgs.buttonLeaderboard,s.bind(this,STATE_LEADERBOARD));o=670;this.buttonRestartLeaderboard=new Button(function(){return this.canvas.width/2-this.imgs.buttonRestart.width-a/2}.bind(this),o,this.imgs.buttonRestart,s.bind(this,STATE_START));var d=function(){var t=this.text;if(!isLegalName(t)){console.log("'"+t+"' is not a valid name.");return}console.log("Submitting best score for '"+t+"': "+this.bestScore);this.submitting=true;this.submittingStartTime=Date.now().valueOf()/1e3;this.errorSubmitting=false;this.submitted=false;this.endTextEntryMode();this.leaderboard[this.leaderboardPos].name=t;submitBestScore(t,this.bestScore,function(){console.log("Submitted score.");this.submitting=false;this.submitted=true}.bind(this),function(t){this.submitting=false;this.submitted=false;console.log("error submitting score: "+t);this.errorSubmitting=true}.bind(this))}.bind(this);var l=function(){if(!this.newBestScore||this.leaderboardLoading||!isLegalName(this.text)||this.submitting||this.submitted)return true;return false}.bind(this);this.buttonSubmit=new DisableButton(function(){return this.canvas.width/2+a/2}.bind(this),o,this.imgs.buttonSubmit,this.imgs.buttonSubmitDisabled,d,l);o=400;this.buttonRestartLeaderboardError=new Button(function(){return this.canvas.width/2-this.imgs.buttonRestart.width-a/2}.bind(this),o,this.imgs.buttonRestart,s.bind(this,STATE_START));this.buttonRetry=new Button(function(){return this.canvas.width/2+a/2}.bind(this),o,this.imgs.buttonRetry,s.bind(this,STATE_LEADERBOARD));this.pipes=[];for(var i=0;i<10;i++){this.pipes[i]=new Pipe(-200)}var p,f;if(typeof document.hidden!=="undefined"){p="hidden";f="visibilitychange"}else if(typeof document.msHidden!=="undefined"){p="msHidden";f="msvisibilitychange"}else if(typeof document.webkitHidden!=="undefined"){p="webkitHidden";f="webkitvisibilitychange"}function u(){if(document[p]){console.log("Page hidden: paused.");t.pause();if(t.state===STATE_PLAYING)t.state=STATE_PAUSED}else{if(t.state!==STATE_PAUSED){console.log("Page unhidden: resumed.");t.unpause()}}}if(typeof document.addEventListener==="undefined"||typeof document[p]==="undefined"){console.log("Error: Page Visibility API not supported.")}else{document.addEventListener(f,u,false)}this.stats=document.getElementById("stats");this.debugAllowed=false;this.debugView=false;this.cameraUpdate=true;this.flappyDt=.08;this.paused=false;this.cameraX=0;this.beginTextEntryMode();this.endTextEntryMode();this.state=STATE_LOADING}Game.prototype.loadImage=function(t,e){if(typeof e==="undefined")e=function(){};if(typeof this.imagesLoadedMax==="undefined")this.imagesLoadedMax=0;this.imagesLoadedMax+=1;var i=new Image;i.onload=function(){e();this.notfiyLoadedImage()}.bind(this);i.src=t;return i};Game.prototype.notfiyLoadedImage=function(){if(typeof this.imagesLoadedNum==="undefined")this.imagesLoadedNum=0;this.imagesLoadedNum+=1;if(this.imagesLoaded){console.log(this.imagesLoadedNum+" images loaded.");this.notifyLoadedResource()}};Game.prototype.notifyLoadedFont=function(){this.notifyLoadedResource()};Game.prototype.notifyLoadedResource=function(){if(this.imagesLoaded&&this.flappyFontLoaded){this.state=STATE_START}};Object.defineProperty(Game.prototype,"imagesLoaded",{get:function(){return this.imagesLoadedNum===this.imagesLoadedMax}});Object.defineProperty(Game.prototype,"flappyCurrent",{get:function(){if(this.deadFlappyImage)return this.imgs.deadFlappy[Math.floor(this.flappyi)];else return this.imgs.flappy[Math.floor(this.flappyi)]}});Object.defineProperty(Game.prototype,"flapButtonDown",{get:function(){return this.lmbDown&&!this.lmbHandled||this.keyWhichs[WHICH_CODE_SPACE]}});Object.defineProperty(Game.prototype,"stateChangeDt",{get:function(){return(Date.now().valueOf()-this.stateChangeTime)/1e3}});Object.defineProperty(Game.prototype,"state",{get:function(){return this.state_},set:function(t){const e=-800;console.log("STATE CHANGE: "+stateToString(this.state_)+" => "+stateToString(t));this.stateChangeTime=Date.now().valueOf();var i=this.state_;this.state_=t;if(t===STATE_LOADING){this.buttons=[];this.bird=new Bird;this.paused=true;this.flappyi=0;this.regenPipes=false;this.cameraUpdate=false;this.flappyVisible=false;this.groundVisible=false}else if(t===STATE_START){this.buttons=[];this.deadFlappyImage=false;this.gravity=0;this.bestScore=getBestScore();this.prevTime=NaN;this.score=0;this.paused=false;this.bird=new Bird;this.flappyi=0;this.oscillate=true;this.regenPipes=false;this.cameraUpdate=true;this.flappyVisible=true;this.groundVisible=true;for(var s=0;s<this.pipes.length;s++){this.pipes[s]=new Pipe(-200)}}else if(t===STATE_PLAYING){this.buttons=[this.buttonPause];this.deadFlappyImage=false;this.gravity=e;this.oscillate=false;this.regenPipes=true;this.paused=false;this.prevTime=NaN;this.cameraUpdate=true;this.flappyVisible=true;this.groundVisible=true;if(i!==STATE_PAUSED){for(var s=0;s<10;s++){this.pipes[s].passed=true;this.pipes[s].x=-200}this.pipeMax=this.bird.posX+Math.max(800,this.canvas.width)}}else if(t===STATE_PAUSED){this.buttons=[this.buttonPlay];this.deadFlappyImage=false;this.gravity=e;this.oscillate=false;this.regenPipes=true;this.paused=true;this.cameraUpdate=true;this.flappyVisible=true;this.groundVisible=true}else if(t===STATE_DEATH){this.buttons=[this.buttonRestartDeath,this.buttonLeaderboard];this.deadFlappyImage=true;this.gravity=e;this.oscillate=false;this.regenPipes=true;this.newBestScore=false;this.cameraUpdate=true;this.flappyVisible=true;this.groundVisible=true;if(this.score>this.bestScore){this.bestScore=this.score;this.newBestScore=true;this.submitted=false;this.errorSubmitting=false;setBestScore(this.bestScore)}this.bird.velY=300;this.bird.velX=0}else if(t===STATE_LEADERBOARD){this.buttons=[this.buttonRestartLeaderboard,this.buttonSubmit];this.deadFlappyImage=true;this.gravity=e;this.oscillate=false;this.regenPipes=true;this.leaderboard=[];this.leaderboardLoading=true;this.cameraUpdate=true;this.flappyVisible=true;this.groundVisible=true;var a=function(t){this.leaderboard=t;this.leaderboardLoading=false;console.log("Leaderboard loaded ("+t.length+" entries)");if(this.newBestScore){var e=-1;for(var i=0;i<NUM_LEADERBOARD_ENTRIES;i++){var s=t[i];if(typeof s==="undefined"||this.bestScore>s.score){e=i;break}}if(e!==-1){this.leaderboardPos=e;t.splice(e,0,{user:true,name:"",score:this.bestScore});this.beginTextEntryMode(MAX_NAME_LENGTH,isLegalNameChar)}}}.bind(this);var n=function(t){console.log("Error loading leaderboard: "+t);this.state=STATE_LEADERBOARD_ERROR}.bind(this);getLeaderboard(a,n)}else if(this.state===STATE_LEADERBOARD_ERROR){this.buttons=[this.buttonRestartLeaderboardError,this.buttonRetry];this.deadFlappyImage=true;this.gravity=e;this.oscillate=false;this.regenPipes=true;this.cameraUpdate=true;this.flappyVisible=true;this.groundVisible=true}else{console.log("Error: Invalid state: "+t);this.state=STATE_START}}});Game.prototype.mainLoop=function(){window.requestAnimationFrame(this.mainLoop.bind(this));this.processKeys();this.update();this.draw();this.keyUps=[];this.keyDowns=[]};Game.prototype.beginTextEntryMode=function(t,e){this.text="";this.textEntry=true;this.textPos=0;if(typeof t==="undefined")t=32;this.textMaxLength=t;if(typeof e==="undefined")e=function(t){return true};this.textIsLegalChar=e};Game.prototype.backspaceText=function(){if(this.text.length>0&&this.textPos>0){var t=this.text.substring(0,this.textPos-1);var e=this.text.substring(this.textPos,this.text.length);this.text=t+e;this.moveCursorText(-1)}};Game.prototype.deleteText=function(){if(this.text.length>0&&this.textPos<this.text.length){this.textPos+=1;this.backspaceText()}};Game.prototype.moveCursorText=function(t){this.textPos+=t;if(this.textPos<0)this.textPos=0;else if(this.textPos>=this.text.length)this.textPos=this.text.length;this.printText()};Game.prototype.printText=function(){var t=this.text.substring(0,this.textPos);var e=this.text.substring(this.textPos,this.text.length);console.log("Text: "+t+"|"+e)};Game.prototype.enterText=function(t){var e="";for(var i=0;i<t.length;i++){var s=t[i];if(this.textIsLegalChar(s))e+=s}var a=this.textMaxLength-this.text.length;if(a<=0){console.log("Prevented from entering text ("+e+"): max length ("+this.textMaxLength+") reached.");return}else if(e.length>a){e=e.substring(0,a)}var n=this.text.substring(0,this.textPos);var r=this.text.substring(this.textPos,this.text.length);this.text=n+e+r;this.moveCursorText(e.length)};Game.prototype.getTextEntered=function(){return this.text};Game.prototype.endTextEntryMode=function(){this.textEntry=false;return this.text};Game.prototype.processKeys=function(){for(var t=0;t<this.keyDowns.length;t++){var e=this.keyDowns[t];var i=e.key;var s=e.code;if(s==="Escape"&&(this.debugAllowed||this.state===STATE_PLAYING||this.state===STATE_PAUSED)){this.togglePause()}if(s==="Digit1"&&this.debugAllowed){this.debugView=!this.debugView}if(s==="Digit2"&&this.debugAllowed){this.cameraUpdate=!this.cameraUpdate}console.log("Key pressed: "+e.which+" '"+i+"' ("+s+")");if(this.textEntry){if(i.length===1){this.enterText(i)}else if(i==="Backspace"){this.backspaceText()}else if(i==="Delete"){this.deleteText()}else if(i==="ArrowLeft"){this.moveCursorText(-1)}else if(i==="ArrowRight"){this.moveCursorText(1)}}}};Game.prototype.pause=function(){if(this.state===STATE_PLAYING){this.state=STATE_PAUSED}else{this.paused=true}};Game.prototype.unpause=function(){if(this.state===STATE_PAUSED){this.state=STATE_PLAYING}else{this.paused=false;this.prevTime=NaN}};Game.prototype.togglePause=function(){if(this.state===STATE_PLAYING){this.state=STATE_PAUSED}else if(this.state===STATE_PAUSED){this.state=STATE_PLAYING}else{this.paused=!this.paused;if(!this.paused)this.prevTime=NaN}};Game.prototype.update=function(){if(this.lmbDown){if(!this.lmbDownPrev){this.lmbHandled=false;var t=this.buttons;for(var e=0;e<t.length;e++){var i=t[e];if(i.handleClick(this.mouseX,this.mouseY)){this.lmbHandled=true;break}}this.lmbDownPrev=true}}else{this.lmbDownPrev=false}if(this.paused)return;var s=Date.now().valueOf();if(isNaN(this.prevTime)){this.prevTime=s}var a=(s-this.prevTime)/1e3;this.prevTime=s;if(this.state===STATE_START&&this.flapButtonDown){this.state=STATE_PLAYING}if(this.state===STATE_START||this.state===STATE_PLAYING)this.flappyi=(this.flappyi+a/this.flappyDt)%this.imgs.flappy.length;this.updateFlappy(a);if(this.regenPipes){for(var e=0;e<this.pipes.length;e++){var n=this.pipes[e];if(!n.passed&&n.x+this.imgs.pipeHead.width/2<this.bird.posX){this.score+=1;n.passed=true}if(n.x+this.imgs.pipeHead.width<this.cameraX){n.reuse(this.pipeMax);this.pipeMax+=PIPE_SPACING_X}}}};Game.prototype.updateFlappy=function(t){var e=this.bird;e.velY+=t*this.gravity;if(this.oscillate){e.t+=t;e.t%=Math.PI*2;e.velY=Math.cos(e.t*4)*70}var i=this.imgs.ground.height+this.flappyCurrent.height/2;if(e.posY<=i&&e.velY<0){e.velY=0}if(e.posY<=i){e.posY=i;if(this.state===STATE_PLAYING)this.state=STATE_DEATH}var s=this.canvas.height;var a=this.flappyCurrent.height/2;if(e.posY+a>s){e.posY=s-a;e.velY=0}e.posX+=t*e.velX;e.posY+=t*e.velY;e.ang=calculateAngle(e.velX,e.velY);e.ang=(e.ang-e.prevAng)*Math.min(1,15*t)+e.prevAng;e.prevAng=e.ang;if(this.state===STATE_START||this.state===STATE_PLAYING){if(this.flapButtonDown){if(!e.flapButtonDownPrev){e.velY=MAX_VEL_Y}e.flapButtonDownPrev=true}else{e.flapButtonDownPrev=false}var n=e.getBB(this.flappyCurrent.width,this.flappyCurrent.height);for(var r=0;r<this.pipes.length;r++){var o=this.pipes[r];var h=n.x+n.w/2,d=n.x-n.w/2;var l=o.x+this.imgs.pipeHead.width,p=o.x;if(d>l||h<p)continue;var f=o.bbUpper(this.imgs.pipeHead.width);var u=o.bbLower(this.imgs.pipeHead.width);var g=false;if(n.intersects(f)){console.log("bird intersects with pipe "+r+" (UPPER)");g=true}else if(n.intersects(u)){console.log("bird intersects with pipe "+r+" (LOWER)");g=true}if(g){this.state=STATE_DEATH}}}};Game.prototype.draw=function(){if(window.innerWidth<MIN_CANVAS_WIDTH)this.canvas.width=MIN_CANVAS_WIDTH;else if(window.innerWidth>MAX_CANVAS_WIDTH)this.canvas.width=MAX_CANVAS_WIDTH;else this.canvas.width=window.innerWidth;if(window.innerHeight<MIN_CANVAS_HEIGHT)this.canvas.height=MIN_CANVAS_HEIGHT;else if(window.innerHeight>MAX_CANVAS_HEIGHT)this.canvas.height=MAX_CANVAS_HEIGHT;else this.canvas.height=window.innerHeight;var t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height);t.imageSmoothingEnabled=false;if(this.cameraUpdate)this.cameraX=this.bird.posX-60-this.canvas.width/20;if(this.debugView){this.drawStats()}else{this.stats.style.visibility="hidden"}if(this.groundVisible){drawImageTiled(t,this.imgs.bgBlank);var e=-this.imgs.bg.width-this.cameraX/2%this.imgs.bg.width;drawImageTiled(t,this.imgs.bg,e,t.canvas.height-this.imgs.bg.height,undefined,1);for(var i=0;i<this.pipes.length;i++){this.drawPipe(t,this.pipes[i])}var s=-this.imgs.ground.width-this.cameraX%this.imgs.ground.width;drawImageTiled(t,this.imgs.ground,s,t.canvas.height-this.imgs.ground.height,undefined,1)}if(this.flappyVisible)this.drawFlappy(t);this.drawUI(t)};Game.prototype.drawUI=function(t){if(this.state===STATE_LOADING)this.drawLoadingUI(t);if(this.state===STATE_START)this.drawStartUI(t);if(this.state===STATE_PLAYING||this.state===STATE_PAUSED)this.drawPlayingUI(t);if(this.state===STATE_DEATH)this.drawDeathUI(t);if(this.state===STATE_LEADERBOARD)this.drawLeaderboardUI(t);if(this.state===STATE_LEADERBOARD_ERROR)this.drawLeaderboardErrorUI(t);var e=this.buttons;for(var i=0;i<e.length;i++){var s=e[i];s.draw(t)}};Game.prototype.drawLoadingUI=function(t){var e=t.canvas.width/2;var i=t.canvas.height/2;if(this.flappysLoaded)this.drawLoadingAnimation(t,this.stateChangeDt,e,i,false)};Game.prototype.drawPlayingUI=function(t){t.textAlign="left";t.textBaseline="top";t.font="30px FlappyFont";drawFlappyText(t,this.score,100,50,"white",2)};Game.prototype.drawStartUI=function(t){t.textAlign="center";t.textBaseline="top";t.font="60px FlappyFont";var e=Math.floor(t.canvas.width/2);var i="gold";drawFlappyText(t,"Flappy",e,150,i);drawFlappyText(t,"Clone",e,150+60+20,i);drawImage(t,this.imgs.tapInfo,120+this.bird.posX-this.cameraX,t.canvas.height-BIRD_START_Y-this.imgs.tapInfo.height/2)};Game.prototype.drawDeathUI=function(t){t.textAlign="center";t.textBaseline="top";t.font="60px FlappyFont";var e="gold";drawFlappyText(t,"Game Over",Math.floor(t.canvas.width/2),200,e);t.font="30px FlappyFont";var i=70;var s=Math.floor(t.canvas.width/2-i);var a=Math.floor(t.canvas.width/2+i);var n=290;var r=340;var o=3;drawFlappyText(t,"Score",s,n,"white",o);drawFlappyText(t,"Best",a,n,"white",o);drawFlappyText(t,this.score,s,r,"white",o);drawFlappyText(t,this.bestScore,a,r,"white",o);if(this.newBestScore)drawImage(t,this.imgs.new,a+27,n-10)};Game.prototype.drawLeaderboardUI=function(t){this.drawLeaderboardHeader(t);if(this.leaderboardLoading){var e=t.canvas.width/2;var i=380;this.drawLoadingAnimation(t,this.stateChangeDt,e,i,true)}else{this.drawLeaderboard(t)}};Game.prototype.drawLeaderboardErrorUI=function(t){var e=this.imgs.deadFlappy[2];var i=-e.width/2;var s=-e.height/2;var a=t.canvas.width/2;var n=345;t.translate(a,n);t.rotate(Math.PI);drawImage(t,e,i,s);t.rotate(-Math.PI);t.translate(-a,-n);t.textAlign="center";t.textBaseline="top";t.font="60px FlappyFont";drawFlappyText(t,"Error",a,110,"red");var r=50,o=210;t.font="30px FlappyFont";drawFlappyText(t,"The leaderboard could",a,o,"white",3);drawFlappyText(t,"not be loaded.",a,o+r,"white",3)};Game.prototype.drawLeaderboardHeader=function(t){t.textAlign="center";t.textBaseline="top";t.font="60px FlappyFont";var e="gold";drawFlappyText(t,"Leaderboard",Math.floor(t.canvas.width/2),110,e)};Game.prototype.drawLeaderboard=function(t){t.textBaseline="top";t.font="30px FlappyFont";var e=3;var i=t.measureText("SCORE").width;var s=8;var a=t.canvas.width-140;var n=60;var r=200;var o="gold";t.textAlign="right";drawFlappyText(t,"NAME",a-s,r,o,e);drawFlappyText(t,"#",n,r,o,e);t.textAlign="left";drawFlappyText(t,"SCORE",a+s,r,o,e);var h=a+s+i/2;for(var d=0;d<NUM_LEADERBOARD_ENTRIES;d++){var l=this.leaderboard[d];if(typeof l==="undefined")break;var p="white";var f=f=Math.floor(5*this.stateChangeDt%3)===0;if(l.user&&this.errorSubmitting){p="red"}else if(l.user){p="gold"}r+=40;t.textAlign="right";if(this.textEntry&&l.user){var u=this.text.substring(0,this.textPos);var g=this.text.substring(this.textPos,this.text.length);var c="|";if(f)c=" ";var m=u+c+g;drawFlappyText(t,m,a-s,r,p,3)}else if(this.submitting&&l.user){var y=Date.now().valueOf()/1e3;var b=y-this.submittingStartTime;var v=Math.floor(2*b%3+1);var T=".".repeat(v);drawFlappyText(t,T,a-s,r,p,3)}else if(this.errorSubmitting&&l.user){drawFlappyText(t,"ERROR",a-s,r,p,3)}else{var w=a-2*s-n;drawFlappyText(t,l.name,a-s,r,p,3,w,false)}drawFlappyText(t,d+1+".",60,r,p,3);t.textAlign="center";drawFlappyText(t,l.score,h,r,p,3)}};Game.prototype.drawLoadingAnimation=function(t,e,i,s,a){var n=5*e%(2*Math.PI);var r=15*e%this.imgs.flappy.length;var o=Math.floor(2*e%3+1);var h=this.imgs.flappy[Math.floor(r)];if(a){var d=".".repeat(o);t.textAlign="middle";t.textBaseline="bottom";t.font="30px FlappyFont";drawFlappyText(t,d,i,s+8,"white",2)}var l=-35;var p=-h.width/2;var f=-h.height/2;t.translate(i,s);t.rotate(n);t.translate(0,l);drawImage(t,h,p,f);t.translate(0,-l);t.rotate(-n);t.translate(-i,-s)};Game.prototype.drawStats=function(){this.stats.style.visibility="visible";var t="";t+="Score: "+this.score+"<br>";t+="Paused: "+this.paused+"<br>";t+="State: "+stateToString(this.state)+"<br>";t+="PosX: "+this.bird.posX.toFixed(2)+"<br>";t+="PosY: "+this.bird.posY.toFixed(2)+"<br>";t+="VelX: "+this.bird.velX.toFixed(2)+"<br>";t+="VelY: "+this.bird.velY.toFixed(2)+"<br>";t+="Gravity: "+this.gravity;this.stats.innerHTML=t};Game.prototype.drawFlappy=function(t){var e=this.bird.posX-this.cameraX;var i=t.canvas.height-this.bird.posY;var s=this.bird.ang;if(this.debugView){t.beginPath();t.moveTo(e,i);t.lineTo(e+this.bird.velX,i-this.bird.velY);t.strokeStyle="black";t.stroke();if(this.state!==STATE_START){t.beginPath();t.moveTo(e,i);var a=10;for(var n=0;n<300;n+=a){var r=n/this.bird.velX;var o=this.bird.velY*r+.5*this.gravity*r*r;t.lineTo(e+n,i-o)}t.strokeStyle="red";t.stroke()}}var h=this.flappyCurrent;var d=-h.width/2;var l=-h.height/2;t.translate(e,i);t.rotate(s);t.translate(d,l);drawImage(t,h,0,0);t.translate(-d,-l);t.rotate(-s);t.translate(-e,-i);if(this.debugView){var p=this.bird.getBB(this.flappyCurrent.width,this.flappyCurrent.height,t.canvas.height);p.x-=this.cameraX;t.strokeStyle="green";p.draw(t)}};Game.prototype.drawPipe=function(t,e){var i=e.x-this.cameraX;var s=t.canvas.height-e.y;var a=s-e.spacing;t.scale(1,-1);drawImageTiled(t,this.imgs.pipe,i,-a,1,undefined);
drawImage(t,this.imgs.pipeHead,i,-a);t.scale(1,-1);drawImageTiled(t,this.imgs.pipe,i,s,1,undefined);drawImage(t,this.imgs.pipeHead,i,s);if(this.debugView){var n=e.bbUpper(this.imgs.pipeHead.width);n.x-=this.cameraX;var r=e.bbLower(this.imgs.pipeHead.width);r.x-=this.cameraX;t.strokeStyle="blue";n.draw(t);r.draw(t);t.beginPath();t.rect(i+this.imgs.pipeHead.width/4*1.5,a,this.imgs.pipeHead.width/4,e.spacing);t.strokeStyle="gold";t.stroke()}};